name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  pr-review:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'pull_request_review_comment' && github.event.comment.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       github.event.comment.user.type != 'Bot' &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    environment: pr-action
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}

      - name: Load PR Review Guidelines
        id: guidelines
        run: |
          if [ -f ".github/pr-review-guidelines.md" ]; then
            echo "GUIDELINES<<EOF" >> $GITHUB_OUTPUT
            cat .github/pr-review-guidelines.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "GUIDELINES=No custom guidelines found. Use standard Python best practices." >> $GITHUB_OUTPUT
          fi

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          show_full_output: true
          allowed_bots: '*'
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
            
            ${{ github.event_name == 'pull_request_review_comment' && format('A developer replied to your review comment: "{0}"', github.event.comment.body) || '' }}
            
            ${{ github.event_name == 'issue_comment' && format('A developer mentioned you: "{0}"', github.event.comment.body) || '' }}

            # PR REVIEW GUIDELINES
            ${{ steps.guidelines.outputs.GUIDELINES }}

            ---

            ${{ github.event_name == 'pull_request' && 'TASK: Review this PR and provide a comprehensive review summary following the "Review Output Format" specified in the guidelines above. Your review should include:

            1. A "Claude PR Overview" header
            2. A "Claude PR Summary" section with key findings in bullet points
            3. A "Confidence Score: X/5" section with detailed reasoning
            4. An "Important Files Changed" section with a markdown table showing each file, its score, and overview

            After posting the summary as a PR comment, also add inline code review comments on specific lines where you found issues.

            Note: The PR branch is already checked out.' || 'TASK: Please respond appropriately to the developer comment above based on the context of your previous review.' }}

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,mcp__github_inline_comment__reply_to_comment,Bash(gh pr comment:*,gh api:*)"